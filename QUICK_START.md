# 🚀 クイックスタートガイド - ビルド＆デプロイ

このガイドでは、Tools28 Revitアドインを**ビルド（コンパイル）してRevitに配置（デプロイ）する方法**を、初心者にも分かりやすく説明します。

---

## 📋 目次

1. [前提条件](#前提条件)
2. [基本的な流れ](#基本的な流れ)
3. [方法1: QuickBuild.ps1（推奨・最速）](#方法1-quickbuildps1推奨最速)
4. [方法2: Visual Studioから手動ビルド](#方法2-visual-studioから手動ビルド)
5. [動作確認](#動作確認)
6. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

### ✅ 必須ソフトウェア

以下のいずれかがインストールされている必要があります：

- **Visual Studio 2019以降**（推奨: Visual Studio 2022）
  - Community版（無料）で問題ありません
  - インストール時に「**.NETデスクトップ開発**」ワークロードを選択

または

- **Build Tools for Visual Studio 2019以降**
  - 軽量版（Visual Studio IDE不要）

### ✅ Revitのインストール

- **Revit 2021、2022、2023、2024、2025、2026のいずれか**
  - デフォルトでは **Revit 2022** 向けにビルドされます
  - 別のバージョンを使用する場合は、後述の設定変更が必要です

---

## 基本的な流れ

```
コードを修正
    ↓
ビルド（コンパイル）← Tools28.dll を生成
    ↓
デプロイ（配置）    ← DLLをRevitのアドインフォルダにコピー
    ↓
Revitを起動/再起動  ← アドインが読み込まれる
```

---

## 方法1: QuickBuild.ps1（推奨・最速）

### 📝 概要

`QuickBuild.ps1` は、**ビルドとデプロイを自動で実行**してくれるPowerShellスクリプトです。
開発中は、このスクリプトを使うのが最も効率的です。

### 🔧 手順

#### 1. PowerShellを開く

**方法A: エクスプローラーから**

1. エクスプローラーで `Revit-Add-ins` フォルダを開く
2. フォルダ内の空白部分を **Shift + 右クリック**
3. 「**PowerShellウィンドウをここで開く**」または「**ターミナルをここで開く**」を選択

**方法B: スタートメニューから**

1. スタートメニューで「PowerShell」を検索
2. 「**Windows PowerShell**」を起動
3. 以下のコマンドでプロジェクトフォルダに移動：
   ```powershell
   cd "C:\Users\<ユーザー名>\Revit-Add-ins"
   ```
   （実際のパスに置き換えてください）

#### 2. 実行ポリシーを変更（初回のみ）

PowerShellスクリプトを初めて実行する場合、以下のコマンドが必要です：

```powershell
Set-ExecutionPolicy -Scope CurrentUser RemoteSigned
```

- 確認メッセージが表示されたら「**Y**」を入力してEnter

> **これは何？**: Windowsのセキュリティ機能で、デフォルトではスクリプト実行が制限されています。
> このコマンドで、ローカルのスクリプト実行を許可します。

#### 3. QuickBuild.ps1 を実行

##### パターンA: デフォルト設定で実行（Revit 2022向け）

```powershell
.\QuickBuild.ps1
```

Enter を押すと、以下が自動実行されます：

1. **ビルド**: `Tools28.dll` を生成
2. **デプロイ**: DLLを `C:\ProgramData\Autodesk\Revit\Addins\2022\` にコピー

##### パターンB: 別のRevitバージョンを指定

```powershell
# Revit 2024向けにビルド＆デプロイ
.\QuickBuild.ps1 -RevitVersion 2024
```

#### 4. 出力を確認

成功すると、以下のようなメッセージが表示されます：

```
========================================
Tools28 - QuickBuild & Deploy
========================================

設定ファイルから読み込み: Revit 2022

========================================
ステップ1: ビルド
========================================

MSBuild: C:\Program Files\...\MSBuild.exe
ビルド中...

✓ ビルドに成功しました

========================================
ステップ2: デプロイ
========================================

デプロイ中...

✓ Tools28.dll をコピーしました
✓ Tools28.pdb をコピーしました
✓ Tools28.addin をコピーしました

========================================
完了しました！
========================================

デプロイ先: C:\ProgramData\Autodesk\Revit\Addins\2022\

次のステップ:
  1. Revit 2022 を起動（または再起動）してください
  2. リボンに「28 Tools」タブが表示されることを確認
  3. 機能をテストしてください
```

#### 5. Revitで確認

1. **Revitを起動**（既に起動している場合は**再起動**）
2. リボンタブに「**28 Tools**」が表示されることを確認
3. 「詳細」パネルの「**領域**」ボタンをクリックして、新しいアイコンが表示されているか確認

---

## 方法2: Visual Studioから手動ビルド

Visual Studio IDEを使用する場合の手順です。

### 🔧 手順

#### 1. ソリューションを開く

1. `Revit-Add-ins` フォルダを開く
2. `Tools28.csproj` をダブルクリック
   → Visual Studio が起動します

#### 2. ビルド構成を設定

1. 上部ツールバーで以下を設定：
   - **構成**: `Release`（デバッグ版の場合は `Debug`）
   - **プラットフォーム**: `Any CPU`

#### 3. 環境変数を設定（Revitバージョン指定）

1. メニュー: **プロジェクト** → **Tools28のプロパティ**
2. 左側メニュー: **ビルド** タブ
3. **詳細設定...** ボタンをクリック
4. 環境変数 `RevitVersion` を設定（例: `2022`）

> **注意**: Visual Studioでは環境変数の設定が面倒なので、
> QuickBuild.ps1を使う方が簡単です。

#### 4. ビルド実行

1. メニュー: **ビルド** → **ソリューションのビルド**
2. 出力ウィンドウで「ビルドに成功しました」を確認

#### 5. 手動デプロイ

ビルドされたDLLを手動でコピーします：

##### コピー元（ビルド出力）

```
Revit-Add-ins\bin\Release\Revit2022\Tools28.dll
Revit-Add-ins\bin\Release\Revit2022\Tools28.pdb
Revit-Add-ins\Packages\2022\28Tools\Tools28.addin
```

##### コピー先（Revitアドインフォルダ）

```
C:\ProgramData\Autodesk\Revit\Addins\2022\
```

**手順**:

1. エクスプローラーで上記の「コピー元」ファイルを選択
2. Ctrl+C でコピー
3. `C:\ProgramData\Autodesk\Revit\Addins\2022\` を開く
4. Ctrl+V で貼り付け（上書き確認が出たら「はい」）

#### 6. Revitで確認

方法1と同じです。

---

## 動作確認

### 1. Revitを起動/再起動

- **重要**: アドインはRevit起動時に読み込まれます
- 既にRevitが起動している場合は、**必ず再起動**してください

### 2. 28 Toolsタブを確認

リボンに「**28 Tools**」タブが表示されているか確認

### 3. アイコンを確認（塗潰し領域機能）

1. 「**28 Tools**」タブをクリック
2. 「**詳細**」パネルを確認
3. 「**領域**」ボタンのアイコンを確認
   - 4つの小さな正方形（ハッチング付き）が2×2配置されている
   - 以前のアイコンより小さくて洗練されたデザイン

### 4. 機能をテスト

1. Revitで塗潰し領域を配置
2. 「領域」ボタンをクリック
3. ダイアログが表示されることを確認

---

## トラブルシューティング

### ❌ エラー: MSBuildが見つかりません

**原因**: Visual Studio がインストールされていない、または古いバージョン

**解決策**:
1. Visual Studio 2019以降をインストール
2. または「Build Tools for Visual Studio」をインストール
   - https://visualstudio.microsoft.com/downloads/
   - 「Tools for Visual Studio」セクションから「Build Tools」をダウンロード

### ❌ エラー: このシステムではスクリプトの実行が無効になっているため...

**原因**: PowerShellの実行ポリシーが制限されている

**解決策**:
```powershell
Set-ExecutionPolicy -Scope CurrentUser RemoteSigned
```

### ❌ エラー: アクセスが拒否されました

**原因**:
- Revitが起動中でDLLがロックされている
- 管理者権限が必要

**解決策**:
1. **Revitを完全に終了**してから再実行
2. PowerShellを**管理者として実行**
   - PowerShellアイコンを右クリック → 「管理者として実行」

### ❌ Revitに「28 Tools」タブが表示されない

**原因1**: デプロイされていない

**解決策**:
1. 以下のフォルダにファイルが存在するか確認：
   ```
   C:\ProgramData\Autodesk\Revit\Addins\2022\
     ├─ Tools28.dll
     └─ Tools28.addin
   ```
2. ない場合は、QuickBuild.ps1を再実行

**原因2**: .addinファイルの設定が間違っている

**解決策**:
1. `C:\ProgramData\Autodesk\Revit\Addins\2022\Tools28.addin` をテキストエディタで開く
2. 内容を確認（DLLパスが正しいか）

**原因3**: Revitのバージョンが違う

**解決策**:
1. 使用しているRevitのバージョンを確認（例: 2024）
2. `.\QuickBuild.ps1 -RevitVersion 2024` で再ビルド

### ❌ アイコンが表示されない（または古いアイコンのまま）

**原因**: Revitが古いDLLをキャッシュしている

**解決策**:
1. Revitを**完全に終了**（タスクマネージャーでプロセスが残っていないか確認）
2. 以下のフォルダを削除（キャッシュクリア）:
   ```
   C:\Users\<ユーザー名>\AppData\Roaming\Autodesk\Revit\Autodesk Revit 2022\
   ```
   （バージョン番号は適宜変更）
3. Revitを再起動

### ❌ ビルドは成功するが、機能が動作しない

**原因**: コードにバグがある

**解決策**:
1. デバッグログを確認:
   ```
   C:\temp\Tools28_debug.txt
   ```
2. Visual Studioでデバッグビルド（Debug構成）を作成
3. Revitにアタッチしてデバッグ実行

---

## 📚 参考情報

### デフォルトのRevitバージョンを変更

`dev-config.json` を編集：

```json
{
  "defaultRevitVersion": "2024",
  "description": "開発時に主に使用するRevitバージョン。QuickBuild.ps1はこの設定を使用します。"
}
```

保存後、`.\QuickBuild.ps1` でRevit 2024向けにビルドされます。

### 全バージョン一括ビルド（リリース用）

```powershell
.\BuildAll.ps1
```

Revit 2021〜2026の全6バージョンを一括ビルドします。

### 配布パッケージ作成

```powershell
.\CreatePackages.ps1 -Version "1.0"
```

`Dist\` フォルダに配布用ZIPが生成されます。

---

## 💡 よくある質問

### Q1. QuickBuild.ps1とBuildAll.ps1の違いは？

| スクリプト | 用途 | ビルド対象 | デプロイ |
|----------|------|----------|--------|
| **QuickBuild.ps1** | 日常的な開発 | 1バージョンのみ（高速） | ✅ 自動 |
| **BuildAll.ps1** | リリース前 | 全6バージョン（時間かかる） | ❌ なし |

開発中は `QuickBuild.ps1` を使い、リリース前に `BuildAll.ps1` で全バージョンをビルドします。

### Q2. ビルドとデプロイの違いは？

- **ビルド**: C#コードをコンパイルして `.dll` ファイルを生成すること
- **デプロイ**: 生成した `.dll` をRevitが読み込める場所にコピーすること

両方が完了して初めて、Revitでアドインが使えるようになります。

### Q3. 毎回QuickBuild.ps1を実行する必要がある？

**はい。**コードを変更したら、必ずビルド＆デプロイが必要です。

ワークフロー:
```
コード修正 → QuickBuild.ps1 → Revit再起動 → テスト
    ↑                                        |
    └────────────────────────────────────────┘
              （問題があれば繰り返し）
```

### Q4. Revitを再起動せずに反映できない？

**基本的にはできません。**

Revitはアドインを起動時に読み込むため、DLLを更新しても**再起動しないと反映されません**。

> **例外**: Hot Reload機能を持つサードパーティツール（Revit Lookup等）を使えば、
> 一部の変更は再起動不要で反映できますが、複雑な設定が必要です。

---

## 🎯 まとめ

### 最も簡単な方法（推奨）

1. PowerShellを開く（`Shift + 右クリック` → 「PowerShellウィンドウをここで開く」）
2. `.\QuickBuild.ps1` を実行
3. Revitを再起動

これだけで、ビルド＆デプロイが完了します！

### 次のステップ

アイコン更新の場合:

1. `Tools\IconGenerator.html` でアイコンをダウンロード
2. `Resources\Icons\filled_region_32.png` に上書き
3. `.\QuickBuild.ps1` を実行
4. Revit再起動 → アイコン確認

---

**お疲れ様でした！** 🎉

不明点があれば、DEVELOPMENT.mdも参照してください。
