# GitHub Actions - Revitアドイン自動ビルド＆パッケージ作成
name: Build and Package

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        revit-version: [2022, 2023, 2024, 2025]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Install Revit API NuGet package
      run: |
        nuget install Revit_All_Main_Versions_API_x64 -Version ${{ matrix.revit-version }}.0.0 -OutputDirectory packages

    - name: Build for Revit ${{ matrix.revit-version }}
      run: |
        msbuild Tools28.csproj /p:Configuration=Release /p:RevitVersion=${{ matrix.revit-version }} /p:RevitAPIPath="${{ github.workspace }}\packages\Revit_All_Main_Versions_API_x64.${{ matrix.revit-version }}.0.0\lib\net48" /verbosity:minimal

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Tools28-Revit${{ matrix.revit-version }}
        path: bin/Release/Revit${{ matrix.revit-version }}/
        retention-days: 30

  package:
    needs: build
    runs-on: windows-latest
    if: success() || failure()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Generate addin files and create packages
      shell: pwsh
      run: |
        $versions = @(2022, 2023, 2024, 2025)

        foreach ($version in $versions) {
          $artifactPath = "artifacts/Tools28-Revit$version"
          $packageDir = "Packages/Tools28_Revit$version"

          if (Test-Path $artifactPath) {
            New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
            Copy-Item "$artifactPath/*" $packageDir -Recurse

            $addinXml = '<?xml version="1.0" encoding="utf-8"?>'
            $addinXml += "`n<RevitAddIns>"
            $addinXml += "`n  <AddIn Type=`"Application`">"
            $addinXml += "`n    <Name>Tools28</Name>"
            $addinXml += "`n    <Assembly>Tools28.dll</Assembly>"
            $addinXml += "`n    <FullClassName>Tools28.Application</FullClassName>"
            $addinXml += "`n    <ClientId>E40A22D9-DD80-4387-BA5D-8F9E4DF157D6</ClientId>"
            $addinXml += "`n    <VendorId>Tools28</VendorId>"
            $addinXml += "`n    <VendorDescription>Tools28 Revit Addin</VendorDescription>"
            $addinXml += "`n  </AddIn>"
            $addinXml += "`n</RevitAddIns>"

            $addinXml | Out-File -FilePath "$packageDir/Tools28.addin" -Encoding UTF8
            Compress-Archive -Path "$packageDir/*" -DestinationPath "Packages/Tools28_Revit$version.zip" -Force
            Write-Host "Created package for Revit $version"
          }
        }

    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: Tools28-AllPackages
        path: Packages/*.zip
        retention-days: 90
        if-no-files-found: ignore

  release:
    needs: package
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'release:')

    steps:
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: Tools28-AllPackages
        path: packages

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: packages/*.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
