# GitHub Actions - Revitアドイン自動ビルド＆パッケージ作成
name: Build and Package

on:
  push:
    branches: [ '**' ]  # すべてのブランチでビルド
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 手動実行も可能

env:
  SOLUTION_NAME: Tools28.csproj

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        revit-version: [2022, 2023, 2024, 2025]
        # 2026は現時点でNuGetパッケージがない可能性があるため除外

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Create NuGet.config for Revit packages
      run: |
        @"
        <?xml version="1.0" encoding="utf-8"?>
        <configuration>
          <packageSources>
            <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
          </packageSources>
        </configuration>
        "@ | Out-File -FilePath NuGet.config -Encoding UTF8

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_NAME }} -PackagesDirectory packages

    - name: Build for Revit ${{ matrix.revit-version }}
      run: |
        msbuild ${{ env.SOLUTION_NAME }} `
          /p:Configuration=Release `
          /p:RevitVersion=${{ matrix.revit-version }} `
          /p:UseNuGetRevitAPI=true `
          /verbosity:minimal

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Tools28-Revit${{ matrix.revit-version }}
        path: bin/Release/Revit${{ matrix.revit-version }}/
        retention-days: 30

  package:
    needs: build
    runs-on: windows-latest
    # すべてのブランチでパッケージ作成を実行

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Generate addin files and create packages
      run: |
        # 各バージョンのパッケージを作成
        $versions = @(2022, 2023, 2024, 2025)

        foreach ($version in $versions) {
          $artifactPath = "artifacts/Tools28-Revit$version"
          $packageDir = "Packages/Tools28_Revit$version"

          if (Test-Path $artifactPath) {
            # パッケージディレクトリ作成
            New-Item -ItemType Directory -Force -Path $packageDir

            # DLLをコピー
            Copy-Item "$artifactPath/*" $packageDir -Recurse

            # .addinファイルを生成
            $addinContent = @"
        <?xml version="1.0" encoding="utf-8"?>
        <RevitAddIns>
          <AddIn Type="Application">
            <Name>Tools28</Name>
            <Assembly>Tools28.dll</Assembly>
            <FullClassName>Tools28.Application</FullClassName>
            <ClientId>E40A22D9-DD80-4387-BA5D-8F9E4DF157D6</ClientId>
            <VendorId>Tools28</VendorId>
            <VendorDescription>Tools28 Revit Addin</VendorDescription>
          </AddIn>
        </RevitAddIns>
        "@
            $addinContent | Out-File -FilePath "$packageDir/Tools28.addin" -Encoding UTF8

            # ZIPに圧縮
            Compress-Archive -Path "$packageDir/*" -DestinationPath "Packages/Tools28_Revit$version.zip" -Force

            Write-Host "Created package for Revit $version"
          }
        }

    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: Tools28-AllPackages
        path: Packages/*.zip
        retention-days: 90

  release:
    needs: package
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'release:')

    steps:
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: Tools28-AllPackages
        path: packages

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: packages/*.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
