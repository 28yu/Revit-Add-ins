# 新機能設計書: 塗潰し領域 分割/統合

---

## 📋 基本情報

| 項目 | 内容 |
|------|------|
| **機能名（日本語）** | 塗潰し領域 分割/統合 |
| **機能名（英語）** | FilledRegion Split/Merge |
| **クラス名** | FilledRegionSplitMergeCommand |
| **優先度** | 高 |
| **実装予定日** | 2026-02-10 |

### 概要
既に作図されている塗潰し領域を分割、統合できる機能。複数のエリアを持つ1つの塗り潰し領域を個別の領域に分割したり、複数の独立した塗り潰し領域を1つにまとめたりすることができます。

### 目的・背景
Revitでは複数のエリアを含む塗り潰し領域を作成できますが、後から分割したり統合したりする標準機能がありません。この機能により、作図後に塗り潰し領域の構成を柔軟に変更でき、作業効率が向上します。

---

## 🎨 UI設計

### リボン配置

| 項目 | 内容 |
|------|------|
| **リボンタブ** | 28 Tools（固定） |
| **リボンパネル** | 詳細 |
| **ボタン名** | 領域 |
| **ツールチップ** | 配置されている塗潰領域を分割/統合します |

### アイコン

- [x] アイコンが必要
  - ファイル名: `Resources/Icons/FilledRegionSplitMerge.png`
  - サイズ: 32x32 PNG
  - デザイン案: 塗り潰し領域のアイコンに分割線（縦線）と統合矢印（→←）を重ねたデザイン

- [ ] アイコン不要（テキストボタンのみ）

### ダイアログ（UI）

- [x] ダイアログ（WPF）が必要
  - タイトル: 塗潰し領域 分割/統合
  - 入力項目:
    - ラジオボタン: 「分割」または「統合」を選択
    - 統合時のみ: 塗り潰しパターン選択（ComboBox）
      - プロジェクト内の全塗り潰しパターンを表示
      - 選択された領域のパターンが同じ場合、そのパターンをデフォルト選択
  - ボタン:
    - [x] OK / キャンセル
    - [ ] 適用 / 閉じる
    - [ ] その他: ___________

- [ ] ダイアログ不要（即座に実行）

---

## 🔧 技術仕様

### 対象ビュー・要素

| 項目 | 内容 |
|------|------|
| **対象ビュータイプ** | 塗り潰し領域が作成できる全ビュー（平面図、断面図、立面図など） |
| **対象要素** | 塗り潰し領域（FilledRegion） |
| **選択方法** | 事前選択 または ダイアログ後に選択 |

### トランザクション

- [x] `TransactionMode.Manual`（推奨 - 手動制御）
- [ ] `TransactionMode.ReadOnly`（読み取り専用）
- [ ] `TransactionMode.Automatic`（自動）

### 使用するRevit API

- `Document`
- `Transaction`
- `FilledRegion` - 塗り潰し領域オブジェクト
- `FilledRegionType` - 塗り潰しパターンのタイプ
- `FilteredElementCollector` - 要素の取得
- `FilledRegion.GetBoundaries()` - 境界線（CurveLoop）の取得
- `Document.Create.NewFilledRegion()` - 新しい塗り潰し領域の作成
- `Element.GetTypeId()` - パターンIDの取得
- `CurveLoop` - 境界線のループ

### 条件付きコンパイル

- [ ] バージョン固有の処理が必要

- [x] 全バージョン共通
  - FilledRegion APIは2022以降で安定

---

## 📝 機能詳細

### 処理フロー

#### 全体フロー

```
1. ユーザーが塗り潰し領域を選択（オプション）
   ↓
2. リボンボタン「領域」をクリック
   ↓
3. 選択チェック
   - 選択あり → ステップ4へ
   - 選択なし → 「塗り潰し領域を選択してください」メッセージ → 選択待機
   ↓
4. 選択された領域の分析
   - 1つの領域で複数エリア → 「分割」有効
   - 複数の領域 → 「統合」有効
   - 両方該当 → 両方有効
   ↓
5. ダイアログ表示
   - 分割/統合のラジオボタン（無効な方はグレーアウト）
   - 統合選択時: パターン選択ComboBox表示
   ↓
6. ユーザーが選択してOKクリック
   ↓
7. トランザクション開始
   ↓
8-A. 分割処理 または 8-B. 統合処理
   ↓
9. トランザクションコミット
   ↓
10. 完了メッセージ表示（「X個の領域に分割しました」または「X個の領域を統合しました」）
```

#### 8-A. 分割処理の詳細

```
1. 選択された FilledRegion から全ての CurveLoop を取得
   ↓
2. 元の FilledRegionType を取得
   ↓
3. 各 CurveLoop に対して:
   - 新しい FilledRegion を作成（同じタイプ、同じビュー）
   ↓
4. 元の FilledRegion を削除
   ↓
5. 作成された領域数を返す
```

#### 8-B. 統合処理の詳細

```
1. 選択された全ての FilledRegion から全ての CurveLoop を取得
   ↓
2. 全ての CurveLoop を1つのリストに集約
   ↓
3. 選択されたパターンで新しい FilledRegion を作成（複数 CurveLoop を渡す）
   ↓
4. 元の全ての FilledRegion を削除
   ↓
5. 統合された領域数を返す
```

### 入力

| 入力項目 | 型 | 必須 | 説明 |
|---------|-----|------|------|
| 選択された塗り潰し領域 | ICollection<ElementId> | ○ | 処理対象の領域 |
| 操作種別 | enum (Split/Merge) | ○ | 分割または統合 |
| 統合時のパターン | ElementId | △ | 統合時のみ必須、FilledRegionTypeのID |

### 出力

| 出力項目 | 型 | 説明 |
|---------|-----|------|
| 処理件数 | int | 作成された領域数（分割時）または統合された領域数（統合時） |
| 成功/失敗 | bool | 処理の成否 |

### エラーハンドリング

#### エラーケース1: 塗り潰し領域未選択

- **対応**: ダイアログで警告メッセージを表示
- **処理**: 処理を中止、またはユーザーに選択を促す

#### エラーケース2: 分割不可の領域を選択（単一エリアのみ）

- **対応**: 「分割」ボタンをグレーアウト、またはメッセージ表示
- **処理**: 統合のみ選択可能にする

#### エラーケース3: 統合時にパターン未選択

- **対応**: ダイアログで警告メッセージを表示
- **処理**: 再選択を促す

#### エラーケース4: トランザクション失敗

- **対応**: 例外をキャッチ、ロールバック
- **処理**: ユーザーへエラー通知、`C:\temp\Tools28_debug.txt` にログ記録

#### エラーケース5: 読み取り専用ビューでの操作

- **対応**: Revit標準のエラーメッセージを表示
- **処理**: 処理を中止

---

## 🛠️ 実装計画

### ファイル構成

```
Commands/FilledRegionSplitMerge/
├── FilledRegionSplitMergeCommand.cs         # コマンド本体
├── FilledRegionSplitMergeDialog.xaml        # WPFダイアログ
├── FilledRegionSplitMergeDialog.xaml.cs     # ダイアログコードビハインド
└── FilledRegionHelper.cs                     # 分割/統合処理のヘルパークラス
```

### 実装ステップ

#### Phase 1: UI実装

- [x] リボンボタンの作成（Application.cs）
- [x] 32x32 アイコンの作成
- [x] WPFダイアログの基本設計
  - ラジオボタン（分割/統合）
  - ComboBox（パターン選択）
  - OK/キャンセルボタン

#### Phase 2: ロジック実装

- [ ] FilledRegionHelper クラスの実装
  - AnalyzeSelection() - 選択分析
  - SplitFilledRegion() - 分割処理
  - MergeFilledRegions() - 統合処理
- [ ] コマンドクラスの実装
  - 選択取得
  - ダイアログ表示
  - トランザクション制御

#### Phase 3: エラーハンドリング

- [ ] 例外処理の追加
- [ ] 入力値検証の実装
- [ ] ログ機能の実装（debug.txt）

#### Phase 4: テスト

- [ ] 分割機能テスト
- [ ] 統合機能テスト
- [ ] エラーケーステスト
- [ ] バグ修正

### 依存関係

- 既存コードを参考:
  - `Commands/SheetCreation/` - WPFダイアログの実装パターン
  - `Commands/ViewportPosition/` - 複雑な処理フローの参考

---

## 🧪 テスト計画

### テストケース

| No. | テスト内容 | 期待される動作 | 結果 |
|-----|-----------|---------------|------|
| **分割機能** |
| 1 | 複数エリア（2つ）を持つ領域を選択して分割 | 2つの独立した領域に分割される | ☐ |
| 2 | 複数エリア（5つ）を持つ領域を選択して分割 | 5つの独立した領域に分割される | ☐ |
| 3 | 単一エリアの領域を選択 | 「分割」ボタンがグレーアウト | ☐ |
| **統合機能** |
| 4 | 同じパターンの領域2つを選択して統合 | 1つの領域（2エリア）に統合、パターンは維持 | ☐ |
| 5 | 異なるパターンの領域3つを選択して統合 | パターン選択後、1つの領域（3エリア）に統合 | ☐ |
| 6 | 離れた位置の領域を選択して統合 | 位置関係に関わらず統合される | ☐ |
| **エラー処理** |
| 7 | 何も選択せずにコマンド実行 | 「塗り潰し領域を選択してください」メッセージ | ☐ |
| 8 | 塗り潰し領域以外（壁など）を選択 | 「塗り潰し領域を選択してください」メッセージ | ☐ |
| 9 | 統合時にパターンを選択せずOKクリック | 「パターンを選択してください」メッセージ | ☐ |
| 10 | リンクファイルの領域を選択 | 「編集できません」メッセージ | ☐ |
| **UI動作** |
| 11 | 複数エリア領域のみ選択 | 「分割」のみ有効、「統合」グレーアウト | ☐ |
| 12 | 単一エリア領域を複数選択 | 「統合」のみ有効、「分割」グレーアウト | ☐ |
| 13 | 混在（単一+複数エリア）を選択 | 両方のボタンが有効 | ☐ |

### テスト環境

- **OS環境**: Windows 11 Pro
- **Revitバージョン**: Revit 2022（開発環境）
- **ハードウェア**:
  - CPU: 11th Gen Intel(R) Core(TM) i7-11850H @ 2.50GHz
  - RAM: 32.0 GB

### 想定される問題点

1. **境界線の方向性**: CurveLoopの方向（時計回り/反時計回り）が正しくない場合、領域が作成できない可能性
2. **複雑な形状**: 自己交差する境界線や、極端に小さい領域の処理
3. **パターンの可視性**: 選択されたパターンがビュースケールで表示されない場合
4. **パフォーマンス**: 大量の領域（100個以上）を統合する場合の処理時間
5. **ビューの依存性**: FilledRegionはビュー固有の要素なので、異なるビューの領域は統合できない

---

## 📚 参考資料

### 既存コード

- `Commands/SheetCreation/SheetCreationDialog.xaml` - WPFダイアログ実装
- `Commands/ViewportPosition/ViewportPositionCommand.cs` - 複雑な処理フローの参考

### 外部ドキュメント

- Revit API Docs: https://www.revitapidocs.com/
- FilledRegion クラス: https://www.revitapidocs.com/2022/b9bc4f58-9b30-f8e7-b5c0-ee9e3b4f4a60.htm
- FilledRegionType クラス: https://www.revitapidocs.com/2022/0dfc3579-9f91-9e46-4e56-5e6f8a8c0c7d.htm
- CurveLoop クラス: https://www.revitapidocs.com/2022/d6c4b8a6-3e5a-d5e0-3e3e-8c2e2c8c0c7d.htm
- Document.Create.NewFilledRegion(): https://www.revitapidocs.com/2022/c0c8e8f4-1b3a-4e3e-8c2e-2c8c0c7d6c4b.htm

---

## ✅ チェックリスト

### 設計フェーズ

- [x] 基本情報を記入
- [x] UI設計を決定
- [x] 技術仕様を確認
- [x] 処理フローを明確化
- [x] テストケースを作成

### 実装フェーズ

- [ ] コマンドクラスを実装
- [ ] リボンに登録
- [ ] アイコンを作成
- [ ] WPFダイアログを作成
- [ ] ヘルパークラスを実装
- [ ] QuickBuild.ps1でビルド成功
- [ ] Revit 2022で動作確認

### リリースフェーズ

- [ ] 全バージョンでビルド成功
- [ ] 複数バージョンで動作確認
- [ ] ドキュメント更新
- [ ] 配布パッケージ作成

---

## 📝 備考・メモ

### 技術的な注意点

1. **FilledRegion.GetBoundaries()** は `IList<CurveLoop>` を返す
   - 複数のCurveLoopがある場合は、それぞれが独立したエリア
   - 1つのCurveLoopの場合は単一エリア

2. **NewFilledRegion()** は複数のCurveLoopを受け取れる
   - これにより統合処理が可能

3. **CurveLoopの方向**:
   - 外側の境界は反時計回り
   - 内側の境界（穴）は時計回り
   - 方向が正しくないとエラーになる可能性

4. **同じビュー内の領域のみ処理可能**
   - FilledRegionはビュー固有の要素
   - 異なるビューの領域は統合できない

### 実装の優先順位

1. **Phase 1**: 基本的な分割機能（複数エリア→独立領域）
2. **Phase 2**: 基本的な統合機能（複数領域→1つの領域）
3. **Phase 3**: パターン選択機能の追加
4. **Phase 4**: エラーハンドリングとUI改善

### 将来の拡張案

- プレビュー機能（処理前に結果を表示）
- 一括処理（ビュー内の全領域を対象）
- パターンの一括変更機能
