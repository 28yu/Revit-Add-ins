# 新機能設計書: 壁高さ一括変更

> これはFEATURE_TEMPLATE.mdの使用例です。
> 実際の新機能開発時の参考にしてください。

---

## 📋 基本情報

| 項目 | 内容 |
|------|------|
| **機能名（日本語）** | 壁高さ一括変更 |
| **機能名（英語）** | WallHeight |
| **クラス名** | WallHeightCommand |
| **優先度** | 中 |
| **実装予定日** | 2024-02-10 |

### 概要
選択した壁の高さを一括で変更する機能。複数の壁を選択して、一度の操作で同じ高さに揃えることができます。

### 目的・背景
現状、Revitで複数の壁の高さを変更する際、1つずつプロパティを編集する必要があり、作業効率が悪い。この機能により、選択した壁の高さを一括で変更でき、作業時間を大幅に短縮できます。

---

## 🎨 UI設計

### リボン配置

| 項目 | 内容 |
|------|------|
| **リボンタブ** | 28 Tools（固定） |
| **リボンパネル** | 編集 |
| **ボタン名** | 壁高さ変更 |
| **ツールチップ** | 選択した壁の高さを一括変更します |

### アイコン

- [x] アイコンが必要
  - ファイル名: `Resources/Icons/WallHeight.png`
  - サイズ: 32x32 PNG
  - デザイン案: 壁のアイコンに上下矢印を重ねたデザイン

- [ ] アイコン不要（テキストボタンのみ）

### ダイアログ（UI）

- [x] ダイアログ（WPF）が必要
  - タイトル: 壁高さ一括変更
  - 入力項目:
    - 新しい高さ（数値入力、単位：mm）
    - 基準レベルからのオフセット（チェックボックス）
  - ボタン:
    - [x] OK / キャンセル
    - [ ] 適用 / 閉じる
    - [ ] その他: ___________

- [ ] ダイアログ不要（即座に実行）

---

## 🔧 技術仕様

### 対象ビュー・要素

| 項目 | 内容 |
|------|------|
| **対象ビュータイプ** | 全ビュー |
| **対象要素** | 壁（Wall） |
| **選択方法** | 事前選択 |

### トランザクション

- [x] `TransactionMode.Manual`（推奨 - 手動制御）
- [ ] `TransactionMode.ReadOnly`（読み取り専用）
- [ ] `TransactionMode.Automatic`（自動）

### 使用するRevit API

- `Document`
- `Transaction`
- `FilteredElementCollector`
- `Wall`
- `Element.get_Parameter(BuiltInParameter.WALL_USER_HEIGHT_PARAM)`
- `Parameter.Set()`
- `UnitUtils.ConvertToInternalUnits()` (mm → feet変換)

### 条件付きコンパイル

- [ ] バージョン固有の処理が必要

- [x] 全バージョン共通

---

## 📝 機能詳細

### 処理フロー

```
1. ユーザーがボタンをクリック
   ↓
2. 現在の選択要素を取得
   ↓
3. 壁のみをフィルタリング
   ↓
4. 壁が選択されていない場合はエラーメッセージ表示
   ↓
5. ダイアログを表示（現在の高さを表示）
   ↓
6. ユーザーが新しい高さを入力してOKクリック
   ↓
7. トランザクション開始
   ↓
8. 各壁の高さパラメータを変更
   ↓
9. トランザクションコミット
   ↓
10. 結果を表示（変更件数、エラー件数）
```

### 入力

| 入力項目 | 型 | 必須 | 説明 |
|---------|-----|------|------|
| 新しい高さ | double | ○ | 変更後の壁高さ（mm） |
| 基準レベルからのオフセット | bool | × | チェック時はレベルからのオフセットとして処理 |

### 出力

| 出力項目 | 型 | 説明 |
|---------|-----|------|
| 変更件数 | int | 変更された壁の数 |
| エラー件数 | int | 処理に失敗した壁の数 |
| エラー詳細 | List<string> | 失敗した壁のIDとエラー理由 |

### エラーハンドリング

- 対象要素が見つからない場合: "壁が選択されていません"メッセージを表示して終了
- パラメータが編集不可の場合: その壁をスキップし、エラーリストに追加
- トランザクション失敗時: ロールバックして詳細エラーメッセージを表示
- 無効な高さ値（0以下）: ダイアログで入力検証、エラーメッセージ表示

---

## 🛠️ 実装計画

### ファイル構成

```
Commands/WallHeight/
├── WallHeightCommand.cs       # コマンド本体
├── WallHeightDialog.xaml      # WPFダイアログ
├── WallHeightDialog.xaml.cs   # ダイアログコードビハインド
└── (ヘルパーは不要)
```

### 実装ステップ

- [x] 1. コマンドクラスの基本構造を作成
- [x] 2. UIダイアログを作成（WPF + XAML）
- [x] 3. コア処理ロジックを実装
- [x] 4. Application.csにリボンボタンを登録
- [x] 5. アイコンを作成・追加
- [x] 6. エラーハンドリングを追加
- [x] 7. デバッグログを追加

### 依存関係

- 既存コードを参考:
  - `Commands/SheetCreation/` - WPFダイアログの実装パターン
  - `Commands/GridBubble/` - パラメータ変更の基本処理

---

## 🧪 テスト計画

### テストケース

| No. | テスト内容 | 期待される動作 | 結果 |
|-----|-----------|---------------|------|
| 1 | 壁を1つ選択して高さ3000mmに変更 | 高さが3000mmに変更される | ☐ |
| 2 | 壁を10個選択して高さ2700mmに変更 | 全ての壁の高さが2700mmに変更される | ☐ |
| 3 | 何も選択せずにコマンド実行 | "壁が選択されていません"メッセージ | ☐ |
| 4 | 壁以外（床など）を選択して実行 | "壁が選択されていません"メッセージ | ☐ |
| 5 | 高さに0や負の数を入力 | "正の値を入力してください"メッセージ | ☐ |
| 6 | リンクファイルの壁を選択 | その壁をスキップし、エラーリストに追加 | ☐ |
| 7 | カーテンウォールを選択 | 処理されるか、スキップされるか確認 | ☐ |
| 8 | 編集中のグループ内の壁を選択 | 正常に高さが変更される | ☐ |

### テスト環境

- [x] Revit 2022（開発環境）
- [ ] Revit 2024（追加検証）
- [ ] Revit 2026（最新版検証）

### 想定される問題点

1. カーテンウォールは高さパラメータの扱いが特殊（要調査）
2. リンクファイル内の壁は編集できない（スキップ処理が必要）
3. グループ化された壁の編集権限（グループ編集モード時のみ？）
4. スタック壁（Stacked Wall）は別処理が必要か確認

---

## 📚 参考資料

### 既存コード

- `Commands/GridBubble/GridBubbleCommand.cs` - パラメータ変更の基本
- `Commands/SheetCreation/SheetCreationDialog.xaml` - WPFダイアログ実装

### 外部ドキュメント

- Revit API Docs: https://www.revitapidocs.com/
- Wall クラス: https://www.revitapidocs.com/2022/d8e91e7e-e3b9-7e42-8c8c-3e7d11e44d25.htm
- BuiltInParameter: WALL_USER_HEIGHT_PARAM
- UnitUtils: https://www.revitapidocs.com/2022/d9b64f25-85e0-fb7f-bc3b-2e40ccab5d12.htm

---

## ✅ チェックリスト

### 設計フェーズ

- [x] 基本情報を記入
- [x] UI設計を決定
- [x] 技術仕様を確認
- [x] 処理フローを明確化
- [x] テストケースを作成

### 実装フェーズ

- [ ] コマンドクラスを実装
- [ ] リボンに登録
- [ ] アイコンを作成
- [ ] WPFダイアログを作成
- [ ] QuickBuild.ps1でビルド成功
- [ ] Revit 2022で動作確認

### リリースフェーズ

- [ ] 全バージョンでビルド成功
- [ ] 複数バージョンで動作確認
- [ ] ドキュメント更新
- [ ] 配布パッケージ作成

---

## 📝 備考・メモ

- カーテンウォールとスタック壁の処理は実装時に動作確認が必要
- ダイアログのUI/UXは既存の「シート一括作成」と統一感を持たせる
- 将来的には床や天井の高さ変更機能も追加する可能性あり
